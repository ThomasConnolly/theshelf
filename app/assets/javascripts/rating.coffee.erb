class Rating
  constructor: (el) ->
    @$el = $(el)
    @setCurrentRating()
    @bindElements()

  setCurrentRating: ->
    rating = @$el.data('rating')
    @$el.find("#rating_#{rating}").prop('checked', true)

  bindElements: ->
    $('input[name="rating"]').change (event) =>
      id = @$el.data('bookid')
      $.ajax "/books/" + id + "/rate",
        type: "PATCH"
        data:
          rating: $(event.currentTarget).val()
        success: =>
          new UpdateAverage('#avg-rating', id).update()

class UpdateAverage
    constructor: (el, bookId) ->
      @$el = $(el)
      @$bookId = bookId

    update: ->
      $.ajax "/books/" + @$bookId + "/average",
        type: "GET"
        success: (data) =>
          @$el.html(data.attachmentPartial)

$.fn.rating = ->
  new Rating(this)
