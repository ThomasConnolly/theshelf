class Search
  constructor: (el) ->
    @$el = $(el)
    @searchBooks()
    @bindSearch()

  bindSearch: ->
    @$el.keyup =>
      @searchBooks()

  searchBooks: ->
    search_url = "<%= Rails.application.routes.url_helpers.search_books_path %>"
    $.ajax search_url,
      dataType: "json"
      type: "GET"
      data:
        search_box: @$el.val()
      success: (data) =>
        dataJson = data.map (item) ->
          JSON.parse item
        new UpdatesBookGallery($('#book-list'), dataJson).update()

class UpdatesBookGallery
  constructor: (el, data) ->
    @$el = $(el)
    @$data = data
    @clearSearchResults()

  clearSearchResults: ->
    @$el.empty()

  update: ->
    _.each @$data, (item) =>
      template = JST["book"]
      @$el.append(_.template(template(item)))

$.fn.search = ->
  new Search(this)
